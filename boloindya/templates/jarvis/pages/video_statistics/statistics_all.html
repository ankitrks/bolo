{% load jarvis_tag %}
<html>
    <head>
        <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
        <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
        
        <script>
            function process_filter(f_val){
                var qs = window.location.search.replace('?', '');
                var qs_list = qs.split('&');
                var param_name = f_val.split('=')[0];
                var found_param = false;
                for(i=0; i < qs_list.length; i++ ){
                    if( qs_list[i].split('=')[0] == param_name ){
                        found_param = true;
                        qs_list[i] = qs_list[i].split('=')[0] + '=' + f_val.split('=')[1]
                    }
                }
                if(!found_param){ qs_list.push( f_val ); }
                window.location.href = window.location.pathname + '?' + qs_list.join('&');
            }
            $( function() {
                $( "#start_date, #end_date" ).datepicker({
                    dateFormat : 'yy-mm-dd',
                    maxDate : 1,
                    minDate : new Date(2019, 04, 01),
                    onSelect: function(date, datepicker) {
                        var proceed = true;
                        if(datepicker.id == 'end_date'){
                            if( !$('#start_date').val() ){
                                alert("Please select the start date first.");
                                $('#start_date, #end_date').val('');
                                proceed = false;
                            }
                        }
                        if( $('#start_date').val() && $('#end_date').val() ){
                            var sdate = new Date($('#start_date').val());
                            var edate = new Date($('#end_date').val());
                            if( edate <= sdate ){
                                alert("End date should be greater than Start date.");
                                $('#start_date, #end_date').val('');
                                proceed = false;
                            }
                        }
                        if( proceed ){
                            process_filter( datepicker.id + '=' + $('#' + datepicker.id).val() );
                        }
                    },
                });
                $('.filter_apply').click(function(e){
                    e.preventDefault();
                    process_filter( $(this).attr('href').replace('?', '') );
                });
            });
        </script>
    </head>
    <body>
        {% for each_data, each_count in top_data.items %}
            {% with each_data|split:"|" as parts %}
                <a href="?metrics={{ parts.1 }}" class="filter_apply">{{ parts.0 }} - {{ each_count }}</a><br>
            {% endwith %}
        {% endfor %}

        from date: <input type="text" id="start_date" name="start_date" placeholder="Start Date" class="filter_text" value="{{ start_date }}">
        to date: <input type="text" id="end_date" name="end_date" placeholder="End Date" class="filter_text" value="{{ end_date }}">
        &nbsp;&nbsp;|&nbsp;&nbsp;
        <a href="?data_view=daily" class="filter_apply">daily</a> &nbsp;&nbsp;|&nbsp;&nbsp;
        <a href="?data_view=weekly" class="filter_apply">weekly</a> &nbsp;&nbsp;|&nbsp;&nbsp;
        <a href="?data_view=monthly" class="filter_apply">monthly</a><br>
        {% if slabs %}
            breakup:
            {% for each_slab in slabs %}
                <a href="?slab={{ each_slab.0 }}" class="filter_apply">{{ each_slab.1 }}</a>{% if not forloop.last %} &nbsp;&nbsp;|&nbsp;&nbsp;{% endif %}
            {% endfor %}
        {% endif %}

        <div id="myDiv"></div>
        <script type="text/javascript">
            var trace1 = {
                x: {{ x_axis|safe }},
                y: {{ y_axis|safe }},
                text: {{ x_axis|safe }},
                type: 'bar',
                marker: {
                    color: 'rgb(142,124,195)'
                }
            };
            var data = [trace1];
            var layout = {
                title: "{{ graph_title }}",
                font:{
                    family: 'Raleway, sans-serif'
                },
                showlegend: false,
                xaxis: {
                    tickangle: -45
                },
                yaxis: {
                    zeroline: false,
                    gridwidth: 2
                },
                bargap :0.05
            };
            Plotly.newPlot('myDiv', data, layout);
        </script>
    </body>
</html>