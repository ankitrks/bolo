{% extends "payment/base.html" %}

{% load static %}

{% block center_content %}


<div class="row">
    <div class="col-sm-12"  style="margin-left: 10px">
        <div class="box">
            <div class="box-header with-border">
                <h3 class="box-title">Beneficiary</h3>
            </div>
            <div class="box-body">
                <div class="row" style="margin-bottom: 10px">
                    <div class="col-sm-4">
                        <a href="#" class="btn btn-success" data-toggle="modal" data-target="#modal-add-beneficiary">
                            Add Beneficiary
                        </a>
                    </div>
                    <div class="col-sm-4">
                        <form id="import_beneficiary_form" enctype="multipart/form-data">
                            <input type="file" name="beneficiary_file">
                            <a href="#" class="btn btn-primary" id="import_beneficiary">Import Beneficiary</a>
                            <button class="buttonload btn disabled" id="import_beneficiary_loading" style="display: none">
                                <i class="fa fa-refresh fa-spin"></i>Loading
                            </button>
                        </form>
                        
                    </div>
                    <div class="col-sm-4">
                        <div class="input-group">
                            <input type="text" name="q" class="form-control" placeholder="Search...">
                            <span class="input-group-btn">
                                <button type="submit" name="search" id="search-btn" class="btn btn-flat"><i class="fa fa-search"></i>
                                </button>
                            </span>
                        </div>
                    </div>
                </div>
                <div style="margin-left: 10px">
                    <div class="row" id="beneficiaryTable"></div>
                </div>
                
            </div>
        </div>
    </div>
</div>
    {% include "payment/partner/components/add_beneficiary_form.html" %}
{% endblock center_content %}

{% block local_js %}
    
<script type="text/javascript">
let headers =  {
    'Authorization': 'Token ' + getCookie('session_id'),
    'X-CSRFToken': getCookie('csrftoken')
}
$("#beneficiaryTable").jsGrid({
    width: "100%",
    height: "600px",

    inserting: false,
    editing: true,
    sorting: true,
    paging: true,
    pageLoading: true,
    autoload: true,
    pageSize: 15,
    fields: [
        { title: "ID", name: "id", type: "number", visible:false },
        { title: "Name", name: "beneficiary_link", type: "text", width: 60, editing: false,},
        { title: "BI ID", name: "boloindya_id", type: "number", width: 50 },
        { title: "Payment Method", name: "payment_method", type: "select", width: 50, editing: false,
            items: [{
                        text: 'Paytm Wallet', 
                        value:'paytm_wallet'
                    },{
                        text: 'UPI', 
                        value:'upi'
                    },{
                        text: 'Account Transfer',
                        value:'account_transfer'
                    }],
            valueField: "value",             // name of property of item to be used as value
            textField: "text", 
        },
        { title: "PayTM Number", name: "paytm_number", type: "text", width: 75, editing: false },
        { title: "UPI", name: "upi", type: "text", width: 50, editing: false },
        { title: "Account Number", name: "account_number", type: "number", width: 50, editing: false},
        { title: "Bank IFSC", name: "bank_ifsc", type: "text", width: 50, editing: false },
        { title: "Verification Status", name: "verification_status", type: "select", width: 50, editing: false,
            items: [{
                        text: 'Cooling Off', 
                        value:'pending'
                    },{
                        text: 'Verified', 
                        value:'verified'
                    },{
                        text: 'Failed',
                        value:'failed'
                    }],
            valueField: "value",             // name of property of item to be used as value
            textField: "text", 
        },
        { title: "Active", type: "checkbox", name: "is_active", sorting: false, width:22 },
        { type: "control" }
    ],
    controller: {
        loadData: function(filter) {
            console.log("------ loadData ", filter)
            let q = $('[name="q"]').val()
            if(q)
                filter['q'] = q
            filter['page'] = filter['pageIndex']

            return $.ajax({
                type: "GET",
                url: "/api/v1/payment/beneficiary/",
                data: filter,
                headers: headers
            });
        },
        
        insertItem: function(item) {
            return $.ajax({
                type: "POST",
                url: "/api/v1/payment/beneficiary/",
                data: item,
                headers: headers
            });
        },
        
        updateItem: function(item) {
            return $.ajax({
                type: "PUT",
                url: "/api/v1/payment/beneficiary/"+item.id + "/",
                data: item,
                headers: headers
            });
        },
        
        deleteItem: function(item) {
            return $.ajax({
                type: "DELETE",
                url: "/api/v1/payment/beneficiary/"+item.id,
                data: item,
                headers: headers
            });
        }
    }
});

let grid = $("#beneficiaryTable").data("JSGrid");

$('#search-btn').click(function(){
    grid.reset()
});
</script>
<script  type="text/javascript">
    $(document).ready(function(){
        $('#save_beneficiary').on('click', function(){
            let data = $('#beneficiaryForm').serializeArray()
            let formData = {}
            $.each(data, (i, item) => {formData[item.name] = item.value})
            $.ajax('/api/v1/payment/beneficiary/', {
                method: 'POST',
                data: formData,
                headers: headers,
                success: function(response){
                    $('#modal-add-beneficiary').find('#exit_add_beneficiary_form').click()
                    $("#save_beneficiary").show();
                    $("#save_beneficiary_loading").hide();
                    Swal.fire(
                      'Success!',
                      'Beneficiary added successfully! It will be active after 30 mins.',
                      'success'
                    )
                    $("#beneficiaryTable").data("JSGrid").reset();

                    $('[name=name]').val('')
                    $('[name=upi]').val('')
                    $('[name=account_number]').val('')
                    $('[name=confirm_account_number]').val('')
                    $('[name=bank_ifsc]').val('')
                    $('[name=paytm_number]').val('')
                    $('[name=payment_method]').val('paytm_wallet').trigger('change')
                },
                error: function(error){
                    console.log(error)
                    $("#save_beneficiary").show();
                    $("#save_beneficiary_loading").hide();
                    Swal.fire({
                        title: 'Error!',
                        text: error.responseText.slice(0, 150),
                        icon: 'error',
                        confirmButtonText: 'Close'
                    })
                },
                xhr: function(){
                    let xhr = $.ajaxSettings.xhr();
                    $("#save_beneficiary").hide();
                    $("#save_beneficiary_loading").show();
                    return xhr;
                    
                }
            })    
            return true
        });
    });
</script>

<script type="text/javascript">
$(document).ready(function(){
    $("#import_beneficiary").click(function(){
        $.ajax("/api/v1/payment/beneficiary/bulk_create", {
            method: 'POST',
            headers: headers,
            data: new FormData(document.getElementById('import_beneficiary_form')),
            processData: false,
            contentType: false,
            success: function(response){
                Swal.fire(
                  'Success!',
                  'Beneficiary added successfully! They will be active after 30 mins.',
                  'success'
                )
                grid.reset()
                $("#import_beneficiary").show();
                $("#import_beneficiary_loading").hide();
            },
            error: function(error){
                console.log(error)
                Swal.fire({
                    title: 'Error!',
                    text: error.responseText.slice(0, 150),
                    icon: 'error',
                    confirmButtonText: 'Close'
                })
                $("#import_beneficiary").show();
                $("#import_beneficiary_loading").hide();
            },
            xhr: function(){
                let xhr = $.ajaxSettings.xhr();
                $("#import_beneficiary").hide();
                $("#import_beneficiary_loading").show();
                return xhr;
                
            }
        })
    })
});
</script>

<script>

    $(document).ready(function(){
        $('[name=upi]').parents('.form-group').hide()
        $('[name=account_number]').parents('.form-group').hide()
        $('[name=confirm_account_number]').parents('.form-group').hide()
        $('[name=bank_ifsc]').parents('.form-group').hide()

        $('[name=payment_method]').change(function(){
            switch($(this).val()){
                case "paytm_wallet":
                    $('[name=upi]').parents('.form-group').hide()
                    $('[name=account_number]').parents('.form-group').hide()
                    $('[name=confirm_account_number]').parents('.form-group').hide()
                    $('[name=bank_ifsc]').parents('.form-group').hide()
                    $('[name=paytm_number]').parents('.form-group').show()
                    break;
                case "upi":
                    $('[name=upi]').parents('.form-group').show()
                    $('[name=account_number]').parents('.form-group').hide()
                    $('[name=confirm_account_number]').parents('.form-group').hide()
                    $('[name=bank_ifsc]').parents('.form-group').hide()
                    $('[name=paytm_number]').parents('.form-group').hide()
                    break;
                case "account_transfer":
                    $('[name=upi]').parents('.form-group').hide()
                    $('[name=account_number]').parents('.form-group').show()
                    $('[name=confirm_account_number]').parents('.form-group').show()
                    $('[name=bank_ifsc]').parents('.form-group').show()
                    $('[name=paytm_number]').parents('.form-group').hide()
                    break;
            }
        })
    })
</script>
{% endblock local_js %}